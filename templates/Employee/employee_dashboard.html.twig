{% extends 'base.html.twig' %}

{% block title %}Dashboard Employé{% endblock %}

{% block body %}
    <div class="dashboard-container">
        <h1 class="text-center">Dashboard des Ventes</h1>

        <!-- Formulaire de filtre -->
        <form id="filter-form" method="get" class="mt-3">
            <div class="row">
                <div class="col-md-6">
                    <label for="filter-type">Filtrer par :</label>
                    <select id="filter-type" name="filter_type" class="form-control">
                        <option value="game" {% if filter_type == 'game' %}selected{% endif %}>Jeu</option>
                        <option value="agency" {% if filter_type == 'agency' %}selected{% endif %}>Agence</option>
                        <option value="genre" {% if filter_type == 'genre' %}selected{% endif %}>Genre</option>
                    </select>
                </div>

                <div class="col-md-6">
                    <label for="filter-value">Sélectionner :</label>
                    <select id="filter-value" name="filter_value" class="form-control">
                        {% if filter_type == 'game' %}
                            {% for game in games %}
                                <option value="{{ game.id }}" {% if filter_value == game.id %}selected{% endif %}>{{ game.titre }}</option>
                            {% endfor %}
                        {% elseif filter_type == 'agency' %}
                            {% for agency in agencies %}
                                <option value="{{ agency.agencyId }}" {% if filter_value == agency.agencyId %}selected{% endif %}>{{ agency.nom }}</option>
                            {% endfor %}
                        {% elseif filter_type == 'genre' %}
                            {% for genre in genres %}
                                <option value="{{ genre }}" {% if filter_value == genre %}selected{% endif %}>{{ genre }}</option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>
            </div>

            <div class="mt-4 text-center">
                <button type="submit" class="btn btn-primary">Appliquer le filtre</button>
            </div>
        </form>

        <!-- Graphique des ventes -->
        <canvas id="salesChart" width="400" height="150"></canvas>

        <script>
            document.getElementById('filter-type').addEventListener('change', function () {
                document.getElementById('filter-form').submit();
            });

            const salesData = {
                labels: {{ sales_dates|json_encode }},
                datasets: [{
                    label: 'Ventes pour {{ filter_value }}',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1,
                    data: {{ sales|map(sale => sale.copiesSold)|json_encode }}
                }]
            };

            const ctx = document.getElementById('salesChart').getContext('2d');
            const salesChart = new Chart(ctx, {
                type: 'line',
                data: salesData,
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        </script>
    </div>
{% endblock %}